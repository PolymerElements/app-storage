<link rel="import" href="communal-worker.html">
<script>
  (function() {
    'use strict';

    var workerUrl = Symbol('workerUrl');
    var connectsToWorker = Symbol('connectsToWorker');
    var connected = Symbol('connected');
    var messageId = Symbol('messageId');
    var worker = null;

    Polymer.CarbonIndexedDBMirrorClient = function(_workerUrl) {
      this[workerUrl] = _workerUrl;
      this[connected] = false;
      this[messageId] = 0;
      this[connectsToWorker] = null;
    }

    Polymer.CarbonIndexedDBMirrorClient.prototype = {
      validateSession: function(session) {
        return this.post({
          type: 'carbon-mirror-validate-session',
          session
        });
      },

      post: function(message) {
        return this.connect().then(function(worker) {
          return new Promise(function(resolve) {
            var id = this[messageId]++;
            var port = worker.port;

            port.addEventListener('message', function onMessage(event) {
              if (event.data && event.data.id === id) {
                port.removeEventListener('message', onMessage);
                resolve(event.data.result);
              }
            });

            message.id = id;

            port.postMessage(message);
          }.bind(this));
        }.bind(this));
      },

      transaction: function(method, key, value) {
        return this.post({
          type: 'carbon-mirror-transaction',
          method,
          key,
          value
        });
      },

      connect: function() {
        if (this[connected] || this[connectsToWorker]) {
          return this[connectsToWorker];
        }

        console.log('Carbon IndexedDB Client connecting..');

        return this[connectsToWorker] = this.registerWorker().then(
            function(worker) {
          return new Promise(function(resolve) {
            worker.port.addEventListener('message', function(event) {
              if (event.data &&
                  event.data.type === 'carbon-mirror-connected') {
                console.log('Carbon IndexedDB Client connected!');
                this[connected] = true;
                resolve(worker);
              }
            }.bind(this));

            worker.addEventListener('error', error => {
              console.error(error.toString());
            });

            worker.port.start();
            worker.port.postMessage({
              type: 'carbon-mirror-connect'
            });
          });
        }.bind(this));
      },

      registerWorker: function() {
        return Promise.resolve(new Polymer.CommunalWorker(this[workerUrl]));
      }
    }
  })();
</script>
