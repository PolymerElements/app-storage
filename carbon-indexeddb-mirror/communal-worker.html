<script>
  (function() {
    'use strict';

    var WEB_WORKERS = {};
    var HAS_SHARED_WORKER = typeof SharedWorker !== 'undefined';
    var HAS_WEB_WORKER = typeof Worker !== 'undefined';
    var BASE_URI =
        (document.currentScript || document._currentScript)
        .ownerDocument.baseURI;
    var WORKER_SCOPE_URL =
        Polymer.ResolveUrl.resolveUrl('communal-worker-scope.js', BASE_URI);

    Polymer.CommunalWorker = function CommunalWorker (workerUrl) {
      if (HAS_SHARED_WORKER) {
        return new SharedWorker(workerUrl);

      } else if (HAS_WEB_WORKER) {
        if (!WEB_WORKERS.hasOwnProperty(workerUrl)) {
          WEB_WORKERS.workerUrl =
              new Worker(`${WORKER_SCOPE_URL}?${workerUrl}`);
        }

      } else {
        console.error(`This browser does not support SharedWorker or
WebWorker, but at least one of those two features is required for
CommunalWorker to do its thing.`);
      }

      this.channel = new MessageChannel();
      this.webWorker = WEB_WORKERS.workerUrl;

      if (this.webWorker) {
        this.webWorker.postMessage({
          type: 'communal-worker-connect'
        }, [this.channel.port2]);
      }
    }

    Polymer.CommunalWorker.prototype = {
      get port() {
        return this.channel.port1;
      },

      addEventListener: function() {
        if (this.webWorker) {
          return this.webWorker.addEventListener.apply(this.webWorker, arguments);
        }
      },

      removeEventListener: function() {
        if (this.webWorker) {
          return this.webWorker
              .removeEventListener.apply(this.webWorker, arguments);
        }
      }
    };
  })();
</script>
